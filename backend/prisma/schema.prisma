// Prisma 数据库模型定义
// 用于个人博客系统

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 用户模型
// 角色: USER, ADMIN, SUPER_ADMIN
model User {
  id        Int       @id @default(autoincrement())
  email     String    @unique
  password  String
  name      String    @unique
  avatar    String?
  bio       String?
  profileBg String?   // 主页背景图片
  role      String    @default("USER")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  posts     Post[]
  comments  Comment[]
}

// 文章模型
model Post {
  id         Int       @id @default(autoincrement())
  title      String
  slug       String    @unique
  content    String
  excerpt    String?
  coverImage String?
  published  Boolean   @default(false)
  isPublic   Boolean   @default(true)   // 是否公开，公开文章所有人可见
  isDeleted  Boolean   @default(false)  // 软删除标记
  views      Int       @default(0)      // 浏览量
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  
  authorId   Int?
  author     User?     @relation(fields: [authorId], references: [id], onDelete: SetNull)
  
  comments   Comment[]
  tags       Tag[]
  versions   PostVersion[]  // 版本历史
}

// 评论模型
model Comment {
  id        Int      @id @default(autoincrement())
  content   String
  isDeleted Boolean  @default(false)  // 软删除标记
  createdAt DateTime @default(now())
  
  postId    Int
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  authorId  Int?
  author    User?    @relation(fields: [authorId], references: [id], onDelete: SetNull)

  parentId  Int?
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")
}

// 标签模型
model Tag {
  id    Int    @id @default(autoincrement())
  name  String @unique
  slug  String @unique
  
  posts Post[]
}

// 文章版本历史模型
model PostVersion {
  id         Int      @id @default(autoincrement())
  version    Int      // 版本号
  title      String
  content    String
  excerpt    String?
  coverImage String?
  published  Boolean
  isPublic   Boolean
  changeNote String?  // 修改说明
  createdAt  DateTime @default(now())
  
  postId     Int
  post       Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  editorId   Int?     // 编辑者ID
}

// 每日访问统计
model DailyStat {
  id        Int      @id @default(autoincrement())
  date      String   @unique // 格式 YYYY-MM-DD
  views     Int      @default(0)
  visitors  Int      @default(0) // 独立访客数 (简单基于IP/Cookie去重)
  updatedAt DateTime @updatedAt
}
